<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobile WebOS Toolkit</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    :root[data-theme='light'] {
      --bg: #f0f0f0;
      --text: #000;
      --window-bg: white;
      --header-bg: #111827;
      --task-bg: #111827;
      --task-item-bg: #374151;
      --task-item-color: white;
      --button-bg: #e0e0e0;
      --button-text: #000;
      --lock-screen-bg: rgba(0,0,0,0.7);
    }

    :root[data-theme='dark'] {
      --bg: #1e1e1e;
      --text: #fff;
      --window-bg: #2d2d2d;
      --header-bg: #333;
      --task-bg: #111;
      --task-item-bg: #444;
      --task-item-color: #fff;
      --button-bg: #444;
      --button-text: #fff;
      --lock-screen-bg: rgba(0,0,0,0.9);
    }

    .window {
      position: fixed;
      width: 90%;
      max-width: 400px;
      background: var(--window-bg);
      border-radius: 1rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 10;
      overflow: hidden;
      touch-action: none;
      display: none;
    }

    .window.maximized {
      width: 100% !important;
      height: 100% !important;
      max-width: none;
      top: 0 !important;
      left: 0 !important;
      border-radius: 0;
    }

    .window.minimized {
      display: none !important;
    }

    .header {
      background: var(--header-bg);
      color: white;
      padding: 0.6rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
      -webkit-user-select: none;
    }

    .header .controls {
      display: flex;
      gap: 0.5rem;
    }

    .header button {
      background: transparent;
      color: white;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      -webkit-tap-highlight-color: transparent;
    }

    .header button:hover {
      background: rgba(255,255,255,0.2);
    }

    .content {
      padding: 1rem;
      height: calc(100% - 3rem);
      overflow: auto;
    }

    .window.maximized .content {
      height: calc(100% - 3rem) !important;
    }

    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--task-bg);
      display: flex;
      padding: 0.5rem;
      gap: 0.5rem;
      z-index: 100;
      align-items: center;
      overflow-x: auto;
    }

    .task-item {
      background: var(--task-item-bg);
      color: var(--task-item-color);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .task-item:active {
      opacity: 0.8;
    }

    .toggle-theme {
      margin-left: auto;
      background: var(--task-item-bg);
      color: var(--task-item-color);
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 1rem;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    button {
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 0.25rem 0;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
      opacity: 0.8;
    }

    textarea {
      width: 100%;
      height: 150px;
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: var(--window-bg);
      color: var(--text);
      border: 1px solid var(--button-bg);
      resize: none;
      margin-bottom: 0.5rem;
    }

    video {
      width: 100%;
      border-radius: 0.5rem;
      background: black;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      background: var(--button-bg);
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    iframe {
      width: 100%;
      height: 300px;
      border: none;
      border-radius: 0.5rem;
      background: var(--button-bg);
    }

    .calculator {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .calculator-display {
      grid-column: span 4;
      background: var(--button-bg);
      padding: 1rem;
      text-align: right;
      border-radius: 0.5rem;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .calculator button {
      font-size: 1.2rem;
      padding: 0.8rem;
    }

    .calculator button.span-2 {
      grid-column: span 2;
    }

    .clock-display {
      font-size: 3rem;
      text-align: center;
      margin: 1rem 0;
    }

    .alarm-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .alarm-form input {
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--button-bg);
      background: var(--window-bg);
      color: var(--text);
    }

    .alarm-list {
      margin-top: 1rem;
    }

    .alarm-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      border-bottom: 1px solid var(--button-bg);
    }

    .terminal {
      background: var(--button-bg);
      color: var(--text);
      padding: 1rem;
      border-radius: 0.5rem;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
    }

    .terminal-input {
      display: flex;
      margin-top: 0.5rem;
    }

    .terminal-input input {
      flex-grow: 1;
      padding: 0.5rem;
      border-radius: 0.5rem 0 0 0.5rem;
      border: 1px solid var(--button-bg);
      background: var(--window-bg);
      color: var(--text);
    }

    .terminal-input button {
      border-radius: 0 0.5rem 0.5rem 0;
      margin: 0;
    }

    .lock-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--lock-screen-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
    }

    .lock-screen input {
      padding: 0.8rem;
      border-radius: 0.5rem;
      border: none;
      margin: 1rem 0;
      width: 80%;
      max-width: 300px;
    }

    .lock-screen button {
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      border: none;
      background: #4CAF50;
      color: white;
    }

    @media (max-width: 480px) {
      .window {
        width: 95%;
      }
      
      .task-item {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      
      .clock-display {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>

<!-- Lock Screen -->
<div id="lockScreen" class="lock-screen" style="display: none;">
  <h1>WebOS Locked</h1>
  <input type="password" id="lockPassword" placeholder="Enter Password" />
  <button onclick="unlockScreen()">Unlock</button>
</div>

<!-- Notepad App -->
<div id="notepad" class="window" style="top: 100px; left: 20px;">
  <div class="header" id="drag-notepad">
    <span>üìù Notepad</span>
    <div class="controls">
      <button id="minimize-notepad">‚àí</button>
      <button id="maximize-notepad">‚ñ°</button>
      <button id="close-notepad">√ó</button>
    </div>
  </div>
  <div class="content">
    <textarea id="notepadText" placeholder="Type here..."></textarea>
    <button onclick="saveNote()">üíæ Save</button>
    <button onclick="loadNote()">üìÇ Open</button>
  </div>
</div>

<!-- Camera App -->
<div id="camera" class="window" style="top: 150px; left: 30px;">
  <div class="header" id="drag-camera">
    <span>üì∏ Camera</span>
    <div class="controls">
      <button id="minimize-camera">‚àí</button>
      <button id="maximize-camera">‚ñ°</button>
      <button id="close-camera">√ó</button>
    </div>
  </div>
  <div class="content">
    <video id="video" autoplay playsinline></video>
    <button onclick="takePhoto()">üì∑ Take Photo</button>
    <canvas id="photoCanvas" style="display: none;"></canvas>
  </div>
</div>

<!-- Location App -->
<div id="location" class="window" style="top: 200px; left: 40px;">
  <div class="header" id="drag-location">
    <span>üìç Location</span>
    <div class="controls">
      <button id="minimize-location">‚àí</button>
      <button id="maximize-location">‚ñ°</button>
      <button id="close-location">√ó</button>
    </div>
  </div>
  <div class="content">
    <div id="locationInfo">Getting location...</div>
    <button onclick="getLocation()">üîÑ Refresh</button>
    <div id="map" style="height: 200px; background: var(--button-bg); margin-top: 0.5rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
      Map will appear here
    </div>
  </div>
</div>

<!-- File Explorer App -->
<div id="explorer" class="window" style="top: 250px; left: 50px;">
  <div class="header" id="drag-explorer">
    <span>üìÅ Explorer</span>
    <div class="controls">
      <button id="minimize-explorer">‚àí</button>
      <button id="maximize-explorer">‚ñ°</button>
      <button id="close-explorer">√ó</button>
    </div>
  </div>
  <div class="content">
    <button onclick="loadFile()">üìÇ Open File</button>
    <button onclick="saveFile()">üíæ Save File</button>
    <pre id="fileContent">No file loaded</pre>
  </div>
</div>

<!-- Clipboard Viewer App -->
<div id="clipboard" class="window" style="top: 300px; left: 60px;">
  <div class="header" id="drag-clipboard">
    <span>üìã Clipboard</span>
    <div class="controls">
      <button id="minimize-clipboard">‚àí</button>
      <button id="maximize-clipboard">‚ñ°</button>
      <button id="close-clipboard">√ó</button>
    </div>
  </div>
  <div class="content">
    <button onclick="showClipboard()">üì• Paste</button>
    <button onclick="copyToClipboard()">üì§ Copy</button>
    <textarea id="clipboardText" placeholder="Paste or type text here..."></textarea>
    <div id="clipboardStatus"></div>
  </div>
</div>

<!-- Calculator App -->
<div id="calculator" class="window" style="top: 350px; left: 70px;">
  <div class="header" id="drag-calculator">
    <span>üßÆ Calculator</span>
    <div class="controls">
      <button id="minimize-calculator">‚àí</button>
      <button id="maximize-calculator">‚ñ°</button>
      <button id="close-calculator">√ó</button>
    </div>
  </div>
  <div class="content">
    <div class="calculator-display" id="calcDisplay">0</div>
    <div class="calculator">
      <button onclick="clearCalculator()">C</button>
      <button onclick="appendToCalc('(')">(</button>
      <button onclick="appendToCalc(')')">)</button>
      <button onclick="appendToCalc('/')">/</button>
      <button onclick="appendToCalc('7')">7</button>
      <button onclick="appendToCalc('8')">8</button>
      <button onclick="appendToCalc('9')">9</button>
      <button onclick="appendToCalc('*')">√ó</button>
      <button onclick="appendToCalc('4')">4</button>
      <button onclick="appendToCalc('5')">5</button>
      <button onclick="appendToCalc('6')">6</button>
      <button onclick="appendToCalc('-')">-</button>
      <button onclick="appendToCalc('1')">1</button>
      <button onclick="appendToCalc('2')">2</button>
      <button onclick="appendToCalc('3')">3</button>
      <button onclick="appendToCalc('+')">+</button>
      <button onclick="appendToCalc('0')">0</button>
      <button onclick="appendToCalc('.')">.</button>
      <button onclick="backspaceCalc()">‚å´</button>
      <button class="span-2" onclick="calculate()">=</button>
    </div>
  </div>
</div>

<!-- Browser App -->
<div id="browser" class="window" style="top: 400px; left: 80px;">
  <div class="header" id="drag-browser">
    <span>üåê Browser</span>
    <div class="controls">
      <button id="minimize-browser">‚àí</button>
      <button id="maximize-browser">‚ñ°</button>
      <button id="close-browser">√ó</button>
    </div>
  </div>
  <div class="content">
    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
      <input type="text" id="browserUrl" placeholder="Enter URL" style="flex-grow: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--button-bg);" />
      <button onclick="loadUrl()">Go</button>
    </div>
    <iframe id="browserFrame" src="about:blank"></iframe>
  </div>
</div>

<!-- Clock App -->
<div id="clock" class="window" style="top: 450px; left: 90px;">
  <div class="header" id="drag-clock">
    <span>üïì Clock</span>
    <div class="controls">
      <button id="minimize-clock">‚àí</button>
      <button id="maximize-clock">‚ñ°</button>
      <button id="close-clock">√ó</button>
    </div>
  </div>
  <div class="content">
    <div class="clock-display" id="timeDisplay"></div>
    <div id="dateDisplay" style="text-align: center; margin-bottom: 1rem;"></div>
    <h3>Set Alarm</h3>
    <div class="alarm-form">
      <input type="time" id="alarmTime" />
      <input type="text" id="alarmLabel" placeholder="Alarm Label" />
      <button onclick="setAlarm()">Set Alarm</button>
    </div>
    <div class="alarm-list" id="alarmList"></div>
  </div>
</div>

<!-- Terminal App -->
<div id="terminal" class="window" style="top: 500px; left: 100px;">
  <div class="header" id="drag-terminal">
    <span>üí¨ Terminal</span>
    <div class="controls">
      <button id="minimize-terminal">‚àí</button>
      <button id="maximize-terminal">‚ñ°</button>
      <button id="close-terminal">√ó</button>
    </div>
  </div>
  <div class="content">
    <div class="terminal" id="terminalOutput">
      WebOS Terminal v1.0<br>
      Type "help" for commands<br><br>
    </div>
    <div class="terminal-input">
      <input type="text" id="terminalInput" placeholder="Enter command..." onkeypress="handleTerminalKey(event)" />
      <button onclick="executeCommand()">‚Üµ</button>
    </div>
  </div>
</div>

<!-- Taskbar -->
<div class="taskbar">
  <div class="task-item" onclick="openApp('notepad')">üìù Notepad</div>
  <div class="task-item" onclick="openApp('camera')">üì∏ Camera</div>
  <div class="task-item" onclick="openApp('location')">üìç Location</div>
  <div class="task-item" onclick="openApp('explorer')">üìÅ Explorer</div>
  <div class="task-item" onclick="openApp('clipboard')">üìã Clipboard</div>
  <div class="task-item" onclick="openApp('calculator')">üßÆ Calculator</div>
  <div class="task-item" onclick="openApp('browser')">üåê Browser</div>
  <div class="task-item" onclick="openApp('clock')">üïì Clock</div>
  <div class="task-item" onclick="openApp('terminal')">üí¨ Terminal</div>
  <button class="toggle-theme" onclick="toggleTheme()">üåì Theme</button>
  <button class="task-item" onclick="lockScreen()">üîí Lock</button>
</div>

<script>
  // Initialize apps
  const apps = [
    'notepad', 'camera', 'location', 'explorer', 'clipboard',
    'calculator', 'browser', 'clock', 'terminal'
  ];
  
  // Initialize window controls for each app
  apps.forEach(app => {
    makeDraggable(app);
    
    // Add event listeners for window controls
    document.getElementById(`minimize-${app}`).addEventListener('click', () => minimizeApp(app));
    document.getElementById(`maximize-${app}`).addEventListener('click', () => maximizeApp(app));
    document.getElementById(`close-${app}`).addEventListener('click', () => closeApp(app));
    
    // Add touch event listeners for mobile
    document.getElementById(`minimize-${app}`).addEventListener('touchend', (e) => {
      e.preventDefault();
      minimizeApp(app);
    });
    document.getElementById(`maximize-${app}`).addEventListener('touchend', (e) => {
      e.preventDefault();
      maximizeApp(app);
    });
    document.getElementById(`close-${app}`).addEventListener('touchend', (e) => {
      e.preventDefault();
      closeApp(app);
    });
  });

  // Window management functions
  function openApp(id) {
    const el = document.getElementById(id);
    el.style.display = 'block';
    el.style.zIndex = Date.now();
    
    // Bring to front when clicked
    el.addEventListener('click', function() {
      this.style.zIndex = Date.now();
    });
    
    // App-specific initialization
    switch(id) {
      case 'camera':
        startCamera();
        break;
      case 'location':
        getLocation();
        break;
      case 'clock':
        updateClock();
        loadAlarms();
        break;
    }
  }

  function closeApp(id) {
    const el = document.getElementById(id);
    el.style.display = 'none';
    el.classList.remove('maximized');
    el.classList.remove('minimized');
    
    // Stop camera when closing
    if (id === 'camera') {
      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    }
  }

  function minimizeApp(id) {
    const el = document.getElementById(id);
    el.classList.add('minimized');
  }

  function maximizeApp(id) {
    const el = document.getElementById(id);
    el.classList.toggle('maximized');
    
    if (el.classList.contains('maximized')) {
      // Store original position and size
      el.dataset.originalTop = el.style.top;
      el.dataset.originalLeft = el.style.left;
      el.dataset.originalWidth = el.style.width;
      
      // Maximize
      el.style.top = '0';
      el.style.left = '0';
      el.style.width = '100%';
      el.style.height = '100%';
    } else {
      // Restore original position and size
      el.style.top = el.dataset.originalTop;
      el.style.left = el.dataset.originalLeft;
      el.style.width = el.dataset.originalWidth;
      el.style.height = '';
    }
  }

  function makeDraggable(id) {
    const el = document.getElementById(id);
    if (!el) return;
    
    const header = el.querySelector('.header');
    let isDragging = false;
    let offsetX, offsetY;
    let startX, startY;

    header.addEventListener('mousedown', startDrag);
    header.addEventListener('touchstart', startDrag, { passive: false });

    function startDrag(e) {
      if (el.classList.contains('maximized')) return;
      
      isDragging = true;
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      
      offsetX = clientX - el.getBoundingClientRect().left;
      offsetY = clientY - el.getBoundingClientRect().top;
      
      startX = clientX;
      startY = clientY;
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('mouseup', stopDrag);
      document.addEventListener('touchend', stopDrag);
      
      if (e.type === 'touchstart') {
        e.preventDefault();
      }
    }

    function drag(e) {
      if (!isDragging) return;
      
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      
      // Calculate new position
      let newLeft = clientX - offsetX;
      let newTop = clientY - offsetY;
      
      // Constrain to viewport
      newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - el.offsetWidth));
      newTop = Math.max(0, Math.min(newTop, window.innerHeight - el.offsetHeight));
      
      el.style.left = newLeft + 'px';
      el.style.top = newTop + 'px';
      
      if (e.type === 'touchmove') {
        e.preventDefault();
      }
    }

    function stopDrag(e) {
      if (!isDragging) return;
      
      const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
      const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
      
      // Check if this was a click (minimal movement)
      if (Math.abs(clientX - startX) < 5 && Math.abs(clientY - startY) < 5) {
        el.style.zIndex = Date.now();
      }
      
      isDragging = false;
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchend', stopDrag);
    }
  }

  // Notepad functions
  async function saveNote() {
    const content = document.getElementById('notepadText').value;
    try {
      if (window.showSaveFilePicker) {
        const handle = await window.showSaveFilePicker({
          types: [{ description: 'Text Files', accept: {'text/plain': ['.txt']} }]
        });
        const writable = await handle.createWritable();
        await writable.write(content);
        await writable.close();
      } else {
        // Fallback for browsers that don't support File System Access API
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'note.txt';
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch (err) {
      console.error('Error saving file:', err);
      alert('Error saving file. Your browser may not support this feature.');
    }
  }

  async function loadNote() {
    try {
      if (window.showOpenFilePicker) {
        const [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        const text = await file.text();
        document.getElementById('notepadText').value = text;
      } else {
        // Fallback for browsers that don't support File System Access API
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt,text/plain';
        input.onchange = e => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = event => {
            document.getElementById('notepadText').value = event.target.result;
          };
          reader.readAsText(file);
        };
        input.click();
      }
    } catch (err) {
      console.error('Error loading file:', err);
      if (err.name !== 'AbortError') {
        alert('Error loading file. Your browser may not support this feature.');
      }
    }
  }

  // Camera functions
  function startCamera() {
    const video = document.getElementById('video');
    
    if (video.srcObject) {
      return; // Camera already started
    }
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        console.error('Camera error:', err);
        video.srcObject = null;
        document.getElementById('camera').querySelector('.content').innerHTML = `
          <p>Could not access camera. Please ensure you've granted permission.</p>
          <button onclick="startCamera()">Try Again</button>
        `;
      });
  }

  function takePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('photoCanvas');
    const contentDiv = document.getElementById('camera').querySelector('.content');
    
    if (!video.srcObject) return;
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Show the photo
    const imgUrl = canvas.toDataURL('image/png');
    contentDiv.innerHTML = `
      <img src="${imgUrl}" style="max-width: 100%; border-radius: 0.5rem;" />
      <button onclick="savePhoto('${imgUrl}')">üíæ Save Photo</button>
      <button onclick="startCamera()">‚Ü©Ô∏è Back to Camera</button>
    `;
  }

  function savePhoto(imgUrl) {
    const a = document.createElement('a');
    a.href = imgUrl;
    a.download = 'photo.png';
    a.click();
  }

  // Location functions
  function getLocation() {
    const loc = document.getElementById('locationInfo');
    loc.textContent = 'Getting location...';
    
    if (!navigator.geolocation) {
      loc.textContent = 'Geolocation is not supported by your browser';
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        loc.innerHTML = `
          <strong>Latitude:</strong> ${latitude.toFixed(6)}<br>
          <strong>Longitude:</strong> ${longitude.toFixed(6)}<br>
          <strong>Accuracy:</strong> ${Math.round(accuracy)} meters
        `;
        
        // Show simple map (using OpenStreetMap iframe)
        document.getElementById('map').innerHTML = `
          <iframe 
            width="100%" 
            height="100%" 
            frameborder="0" 
            scrolling="no" 
            marginheight="0" 
            marginwidth="0" 
            src="https://www.openstreetmap.org/export/embed.html?bbox=${longitude-0.01}%2C${latitude-0.01}%2C${longitude+0.01}%2C${latitude+0.01}&amp;layer=mapnik&amp;marker=${latitude}%2C${longitude}"
            style="border-radius: 0.5rem;">
          </iframe>
        `;
      },
      err => {
        console.error('Geolocation error:', err);
        loc.textContent = 'Unable to retrieve your location: ' + 
          (err.message || 'Permission denied or location unavailable');
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  // File Explorer functions
  async function loadFile() {
    try {
      let file;
      
      if (window.showOpenFilePicker) {
        const [fileHandle] = await window.showOpenFilePicker();
        file = await fileHandle.getFile();
      } else {
        // Fallback for browsers that don't support File System Access API
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
          file = e.target.files[0];
          readFileContent(file);
        };
        input.click();
        return;
      }
      
      readFileContent(file);
    } catch (err) {
      console.error('Error loading file:', err);
      if (err.name !== 'AbortError') {
        alert('Error loading file. Your browser may not support this feature.');
      }
    }
  }

  function readFileContent(file) {
    const reader = new FileReader();
    reader.onload = event => {
      document.getElementById('fileContent').textContent = event.target.result;
    };
    reader.onerror = () => {
      document.getElementById('fileContent').textContent = 'Error reading file';
    };
    reader.readAsText(file);
  }

  async function saveFile() {
    const content = document.getElementById('fileContent').textContent;
    try {
      if (window.showSaveFilePicker) {
        const handle = await window.showSaveFilePicker();
        const writable = await handle.createWritable();
        await writable.write(content);
        await writable.close();
      } else {
        // Fallback for browsers that don't support File System Access API
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'file.txt';
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch (err) {
      console.error('Error saving file:', err);
      alert('Error saving file. Your browser may not support this feature.');
    }
  }

  // Clipboard functions
  async function showClipboard() {
    try {
      const text = await navigator.clipboard.readText();
      document.getElementById('clipboardText').value = text || 'Clipboard is empty.';
      document.getElementById('clipboardStatus').textContent = 'Clipboard content loaded';
      setTimeout(() => {
        document.getElementById('clipboardStatus').textContent = '';
      }, 2000);
    } catch (err) {
      console.error('Clipboard error:', err);
      document.getElementById('clipboardStatus').textContent = 'Clipboard access denied. Paste manually.';
      // Fallback for browsers that don't support clipboard API
      document.getElementById('clipboardText').value = '';
      document.getElementById('clipboardText').focus();
    }
  }

  async function copyToClipboard() {
    const text = document.getElementById('clipboardText').value;
    try {
      await navigator.clipboard.writeText(text);
      document.getElementById('clipboardStatus').textContent = 'Copied to clipboard!';
      setTimeout(() => {
        document.getElementById('clipboardStatus').textContent = '';
      }, 2000);
    } catch (err) {
      console.error('Copy error:', err);
      document.getElementById('clipboardStatus').textContent = 'Failed to copy. Your browser may not support this feature.';
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        document.getElementById('clipboardStatus').textContent = 'Copied to clipboard!';
        setTimeout(() => {
          document.getElementById('clipboardStatus').textContent = '';
        }, 2000);
      } catch (err) {
        document.getElementById('clipboardStatus').textContent = 'Failed to copy. Please copy manually.';
      }
      document.body.removeChild(textarea);
    }
  }

  // Calculator functions
  let calcValue = '0';

  function appendToCalc(char) {
    if (calcValue === '0' && char !== '.') {
      calcValue = char;
    } else {
      calcValue += char;
    }
    updateCalcDisplay();
  }

  function clearCalculator() {
    calcValue = '0';
    updateCalcDisplay();
  }

  function backspaceCalc() {
    if (calcValue.length > 1) {
      calcValue = calcValue.slice(0, -1);
    } else {
      calcValue = '0';
    }
    updateCalcDisplay();
  }

  function calculate() {
    try {
      calcValue = eval(calcValue).toString();
      updateCalcDisplay();
    } catch (e) {
      calcValue = 'Error';
      updateCalcDisplay();
      setTimeout(() => {
        calcValue = '0';
        updateCalcDisplay();
      }, 1000);
    }
  }

  function updateCalcDisplay() {
    document.getElementById('calcDisplay').textContent = calcValue;
  }

  // Browser functions
  function loadUrl() {
    const url = document.getElementById('browserUrl').value;
    if (!url) return;
    
    let fullUrl = url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      fullUrl = 'https://' + url;
    }
    
    try {
      document.getElementById('browserFrame').src = fullUrl;
    } catch (e) {
      console.error('Error loading URL:', e);
      document.getElementById('browserFrame').src = 'about:blank';
    }
  }

  // Clock and Alarm functions
  function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const dateStr = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    document.getElementById('timeDisplay').textContent = timeStr;
    document.getElementById('dateDisplay').textContent = dateStr;
    
    // Check alarms
    checkAlarms(now);
    
    setTimeout(updateClock, 1000);
  }

  function setAlarm() {
    const timeInput = document.getElementById('alarmTime').value;
    const labelInput = document.getElementById('alarmLabel').value || 'Alarm';
    
    if (!timeInput) return;
    
    const alarms = JSON.parse(localStorage.getItem('alarms') || '[]');
    alarms.push({
      time: timeInput,
      label: labelInput,
      id: Date.now()
    });
    
    localStorage.setItem('alarms', JSON.stringify(alarms));
    loadAlarms();
    
    // Clear inputs
    document.getElementById('alarmTime').value = '';
    document.getElementById('alarmLabel').value = '';
  }

  function loadAlarms() {
    const alarms = JSON.parse(localStorage.getItem('alarms') || '[]');
    const alarmList = document.getElementById('alarmList');
    
    alarmList.innerHTML = '';
    
    alarms.forEach(alarm => {
      const alarmItem = document.createElement('div');
      alarmItem.className = 'alarm-item';
      alarmItem.innerHTML = `
        <span>${alarm.label} - ${alarm.time}</span>
        <button onclick="deleteAlarm(${alarm.id})">Delete</button>
      `;
      alarmList.appendChild(alarmItem);
    });
  }

  function deleteAlarm(id) {
    let alarms = JSON.parse(localStorage.getItem('alarms') || '[]');
    alarms = alarms.filter(alarm => alarm.id !== id);
    localStorage.setItem('alarms', JSON.stringify(alarms));
    loadAlarms();
  }

  function checkAlarms(now) {
    const alarms = JSON.parse(localStorage.getItem('alarms') || '[]');
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                       now.getMinutes().toString().padStart(2, '0');
    
    alarms.forEach(alarm => {
      if (alarm.time === currentTime) {
        // Trigger alarm
        if (Notification.permission === 'granted') {
          new Notification(alarm.label, {
            body: 'Alarm! It\'s ' + alarm.time
          });
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(alarm.label, {
                body: 'Alarm! It\'s ' + alarm.time
              });
            }
          });
        }
        
        // Play sound
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
        audio.play();
        
        // Remove the alarm if it's a one-time alarm
        deleteAlarm(alarm.id);
      }
    });
  }

  // Terminal functions
  function handleTerminalKey(e) {
    if (e.key === 'Enter') {
      executeCommand();
    }
  }

  function executeCommand() {
    const input = document.getElementById('terminalInput');
    const command = input.value.trim();
    input.value = '';
    
    if (!command) return;
    
    const output = document.getElementById('terminalOutput');
    output.innerHTML += `$ ${command}<br>`;
    
    // Process command
    const args = command.split(' ');
    const cmd = args[0].toLowerCase();
    
    switch(cmd) {
      case 'help':
        output.innerHTML += `Available commands:<br>
          help - Show this help<br>
          clear - Clear terminal<br>
          open [app] - Open an app (notepad, camera, etc.)<br>
          theme [light/dark] - Change theme<br>
          time - Show current time<br>
          date - Show current date<br><br>`;
        break;
      case 'clear':
        output.innerHTML = '';
        break;
      case 'open':
        if (args.length < 2) {
          output.innerHTML += 'Usage: open [app]<br>Available apps: notepad, camera, location, explorer, clipboard, calculator, browser, clock, terminal<br><br>';
        } else {
          const app = args[1].toLowerCase();
          if (apps.includes(app)) {
            openApp(app);
            output.innerHTML += `Opening ${app}<br><br>`;
          } else {
            output.innerHTML += `Unknown app: ${app}<br><br>`;
          }
        }
        break;
      case 'theme':
        if (args.length < 2) {
          output.innerHTML += 'Usage: theme [light/dark]<br><br>';
        } else {
          const theme = args[1].toLowerCase();
          if (theme === 'light' || theme === 'dark') {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            output.innerHTML += `Theme set to ${theme}<br><br>`;
          } else {
            output.innerHTML += `Invalid theme: ${theme}<br><br>`;
          }
        }
        break;
      case 'time':
        output.innerHTML += new Date().toLocaleTimeString() + '<br><br>';
        break;
      case 'date':
        output.innerHTML += new Date().toLocaleDateString() + '<br><br>';
        break;
      default:
        output.innerHTML += `Command not found: ${cmd}<br>Type "help" for available commands<br><br>`;
    }
    
    // Scroll to bottom
    output.scrollTop = output.scrollHeight;
  }

  // Lock screen functions
  function lockScreen() {
    document.getElementById('lockScreen').style.display = 'flex';
    // Disable all apps
    apps.forEach(app => {
      document.getElementById(app).style.display = 'none';
    });
  }

  function unlockScreen() {
    const password = document.getElementById('lockPassword').value;
    // Simple password check (in a real app, use proper authentication)
    if (password === '1234' || !localStorage.getItem('lockPassword')) {
      document.getElementById('lockScreen').style.display = 'none';
      document.getElementById('lockPassword').value = '';
      
      // If this is the first time, set the password
      if (!localStorage.getItem('lockPassword')) {
        localStorage.setItem('lockPassword', '1234');
      }
    } else {
      alert('Incorrect password');
    }
  }

  // Theme functions
  function toggleTheme() {
    const html = document.documentElement;
    const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    
    // Save preference to localStorage
    try {
      localStorage.setItem('theme', newTheme);
    } catch (e) {
      console.error('Error saving theme preference:', e);
    }
  }

  // Initialize theme from localStorage
  function initTheme() {
    try {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
    } catch (e) {
      console.error('Error loading theme preference:', e);
    }
  }

  // Initialize the app
  initTheme();
  updateClock();
  
  // Request notification permission
  if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission();
  }
</script>
</body>
</html>
